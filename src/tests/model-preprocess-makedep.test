#!/bin/bash -ex

cd ${TEST_TMPDIR}

PATH=${abs_builddir}/../models:${abs_builddir}/../frontend:$PATH
MAGIC="##GGTHUNK##"

BASENAME=server
INPUT_FILE=$DATADIR/$BASENAME.c
OUTPUT_FILE=$BASENAME.i
MAKEDEP_FILE=$BASENAME.Tpo

GCC_M_ARGS="-MT ${BASENAME}.o -MD -MP -MF ${MAKEDEP_FILE}"
GCC_ARGS="-D_FORTIFY_SOURCE=0 -g -O2 -E -frandom-seed=winstein ${INPUT_FILE}"

INCLUDE_ARGS=$(gcc-7 -E -Wp,-v - < /dev/null 2>&1 | grep "^ " | sed 's/ \(.*\)/-isystem\1/' | tr '\n' ' ')

# Run with system GCC
gcc-7 -nostdinc ${INCLUDE_ARGS} ${GCC_ARGS} ${GCC_M_ARGS}.gold -o ${OUTPUT_FILE}.gold

# Create thunk
GG_DIR=.gg/ model-gcc gcc ${GCC_ARGS} ${GCC_M_ARGS} -o ${OUTPUT_FILE}

# Assert it's a thunk
if [ $MAGIC != `head -c 11 ${OUTPUT_FILE}` ]; then
  echo "Failed to create thunk"
  exit 1
fi

# execute thunk
gg-execute -s ${OUTPUT_FILE}

# check difference
diff ${OUTPUT_FILE} ${OUTPUT_FILE}.gold
diff -y -W 200 ${MAKEDEP_FILE} ${MAKEDEP_FILE}.gold
