#!/bin/bash -e

cd ${TEST_TMPDIR}

PATH=${TOOLCHAIN_PATH}:${abs_builddir}/../models:${abs_builddir}/../frontend:$PATH
MAGIC="##GGTHUNK##"

# Run with GCC
${TOOLCHAIN_PATH}/gcc -g -O2 -c -frandom-seed=winstein -o remake.o.gold $DATADIR/remake.s

# Create thunk
GG_DIR=.gg/ model-gcc -g -O2 -c -frandom-seed=winstein -o remake.o $DATADIR/remake.s

# Assert it's a thunk
if [ $MAGIC != `head -c 11 remake.o` ]; then
  echo "Failed to create thunk"
  exit 1
fi

# execute thunk
gg-execute -s remake.o

# check difference
diff remake.o remake.o.gold
