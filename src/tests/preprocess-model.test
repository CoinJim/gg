#!/bin/bash -ex

BIN=.gg/bin
MAGIC="##GGTHUNK##"

# Run with GCC
gcc -g -O2 -E -frandom-seed=winstein -o server.i.gold $DATADIR/test_vectors/server.c

# Create thunk
GG_DIR=.gg/ ../models/model-gcc -g -O2 -E -frandom-seed=winstein -o server.i $DATADIR/test_vectors/server.c


# Assert it's a thunk
if [ $MAGIC != `head -c 11 server.i` ]; then
  echo "Failed to create thunk"
  exit 1
fi


# execute thunk
../frontend/gg-execute -s server.i


# check difference
diff server.i server.i.gold


# Clean up
# Note: Not cleaning up .gg directory
rm -f server.i.gold
rm -f server.i
find .gg -maxdepth 1 -type f -delete

exit 0
