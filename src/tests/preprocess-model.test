#!/bin/bash -ex

MAGIC="##GGTHUNK##"

INPUT_FILE=$DATADIR/test_vectors/server.c
OUTPUT_FILE=server.i

GCC_ARGS="-g -O2 -E -frandom-seed=winstein ${INPUT_FILE}"

INCLUDE_ARGS=$(gcc -E -Wp,-v - < /dev/null 2>&1 | grep "^ " | sed 's/ \(.*\)/-isystem\1/' | tr '\n' ' ')

# Run with system GCC
gcc -nostdinc \
  ${INCLUDE_ARGS} \
  -isystem /usr/lib/gcc/x86_64-linux-gnu/7/include \
  -isystem /usr/local/include \
  -isystem /usr/lib/gcc/x86_64-linux-gnu/7/include-fixed \
  -isystem /usr/include/x86_64-linux-gnu \
  -isystem /usr/include \
  ${GCC_ARGS} -o ${OUTPUT_FILE}.gold

# Create thunk
GG_DIR=.gg/ ../models/model-gcc ${GCC_ARGS} -o ${OUTPUT_FILE}

# Assert it's a thunk
if [ $MAGIC != `head -c 11 ${OUTPUT_FILE}` ]; then
  echo "Failed to create thunk"
  exit 1
fi

# execute thunk
../frontend/gg-execute -s ${OUTPUT_FILE}

# check difference
diff ${OUTPUT_FILE} ${OUTPUT_FILE}.gold

# Clean up
# Note: Not cleaning up .gg directory
rm -f ${OUTPUT_FILE}.gold ${OUTPUT_FILE}
find .gg -maxdepth 1 -type f -delete

exit 0
