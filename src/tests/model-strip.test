#!/bin/bash -xe

cd ${TEST_TMPDIR}

PATH=${abs_builddir}/../models:${abs_builddir}/../frontend:$PATH
MAGIC="##GGTHUNK##"
OUTPUT=curhello.o
INPUT=$DATADIR/curhello.o

cp --no-preserve=mode,ownership ${INPUT} ${OUTPUT}.gold
${TOOLCHAIN_PATH}/strip ${OUTPUT}.gold

cp --no-preserve=mode,ownership ${INPUT} ${OUTPUT}
GG_DIR=.gg/ model-strip ${OUTPUT}

if [ "$MAGIC" != "`head -c 11 ${OUTPUT}`" ]; then
  echo "Failed to create thunk"
  exit 1
fi

gg-execute -s ${OUTPUT}

diff ${OUTPUT} ${OUTPUT}.gold
