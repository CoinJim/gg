#!/bin/bash -xe

cd ${TEST_TMPDIR}

PATH=${abs_builddir}/../models:${abs_builddir}/../frontend:$PATH
MAGIC="##GGTHUNK##"
OUTPUT=libnet.a
INPUT=$DATADIR/libnet.a

cp --no-preserve=mode,ownership ${INPUT} ${OUTPUT}.gold
${TOOLCHAIN_PATH}/ranlib ${OUTPUT}.gold

cp --no-preserve=mode,ownership ${INPUT} ${OUTPUT}
GG_DIR=.gg/ model-ranlib ${OUTPUT}
mv ${OUTPUT} ${OUTPUT}.thunk

if [ "$MAGIC" != "`head -c 11 ${OUTPUT}.thunk`" ]; then
  echo "Failed to create thunk"
  exit 1
fi

cp --no-preserve=mode,ownership ${INPUT} ${OUTPUT}
gg-execute -s ${OUTPUT}.thunk

diff ${OUTPUT} ${OUTPUT}.gold
